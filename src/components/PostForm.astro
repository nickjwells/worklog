---
// PostForm - Simple form to add new posts
---

<div id="post-form-container" class="mb-12 pb-8 form-container">
  <!-- Password prompt (shown when not authenticated) -->
  <div id="password-prompt" class="hidden">
    <div class="flex items-center gap-3">
      <input
        type="password"
        id="password-input"
        placeholder="Enter password to post"
        class="flex-1 px-4 py-3 text-base rounded-xl focus:outline-none focus:ring-2 focus:border-transparent form-input"
      />
      <button
        id="password-submit"
        class="px-6 py-3 font-medium rounded-xl transition-colors accent-btn"
      >
        Unlock
      </button>
    </div>
  </div>

  <!-- Post form (shown when authenticated) -->
  <div id="post-form" class="hidden">
    <textarea
      id="post-content"
      placeholder="What did you do?"
      rows="3"
      class="w-full px-4 py-3 text-lg rounded-xl focus:outline-none focus:ring-2 focus:border-transparent resize-none form-input"
    ></textarea>

    <div class="flex items-center justify-between mt-4">
      <div class="flex gap-2">
        <button
          id="category-update"
          class="px-4 py-2 text-sm font-medium rounded-full transition-colors category-btn active"
          data-category="update"
        >
          Update
        </button>
        <button
          id="category-thought"
          class="px-4 py-2 text-sm font-medium rounded-full transition-colors category-btn"
          data-category="thought"
        >
          Thought
        </button>
      </div>

      <button
        id="submit-post"
        class="px-6 py-2.5 font-medium rounded-full transition-colors flex items-center gap-2 accent-btn"
      >
        <span>Post</span>
        <span class="opacity-70 text-sm">&#8984;&#8629;</span>
      </button>
    </div>

    <!-- Status message -->
    <div id="status-message" class="mt-4 text-sm hidden"></div>
  </div>
</div>

<style>
  .form-container {
    border-bottom: 1px solid var(--color-border);
  }
  .form-input {
    border: 1px solid var(--color-border);
    background-color: var(--color-bg-primary);
    color: var(--color-text-primary);
  }
  .form-input::placeholder {
    color: var(--color-text-secondary);
  }
  .form-input:focus {
    --tw-ring-color: var(--color-accent);
  }
  .accent-btn {
    background-color: var(--color-accent);
    color: white;
  }
  .accent-btn:hover {
    background-color: var(--color-accent-hover);
  }
  .category-btn {
    background-color: var(--color-btn-secondary-bg);
    color: var(--color-text-secondary);
  }
  .category-btn.active {
    background-color: var(--color-btn-primary-bg);
    color: var(--color-btn-primary-text);
  }
  .category-btn:hover:not(.active) {
    background-color: var(--color-btn-secondary-hover);
  }
  #submit-post:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  .status-success {
    color: var(--color-success);
  }
  .status-error {
    color: var(--color-error);
  }
  .status-loading {
    color: var(--color-text-secondary);
  }
</style>

<script>
  const STORAGE_KEY = 'worklog_password';

  const passwordPrompt = document.getElementById('password-prompt') as HTMLDivElement;
  const postForm = document.getElementById('post-form') as HTMLDivElement;
  const passwordInput = document.getElementById('password-input') as HTMLInputElement;
  const passwordSubmit = document.getElementById('password-submit') as HTMLButtonElement;
  const postContent = document.getElementById('post-content') as HTMLTextAreaElement;
  const submitPost = document.getElementById('submit-post') as HTMLButtonElement;
  const statusMessage = document.getElementById('status-message') as HTMLDivElement;
  const categoryBtns = document.querySelectorAll('.category-btn') as NodeListOf<HTMLButtonElement>;

  let selectedCategory: 'update' | 'thought' = 'update';

  // Check if password is stored
  const storedPassword = localStorage.getItem(STORAGE_KEY);
  if (storedPassword) {
    passwordPrompt.classList.add('hidden');
    postForm.classList.remove('hidden');
    postContent.focus();
  } else {
    passwordPrompt.classList.remove('hidden');
    postForm.classList.add('hidden');
  }

  // Password submission
  passwordSubmit.addEventListener('click', () => {
    const password = passwordInput.value.trim();
    if (password) {
      localStorage.setItem(STORAGE_KEY, password);
      passwordPrompt.classList.add('hidden');
      postForm.classList.remove('hidden');
      postContent.focus();
    }
  });

  passwordInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      passwordSubmit.click();
    }
  });

  // Category selection
  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedCategory = btn.dataset.category as 'update' | 'thought';
    });
  });

  // Submit post
  async function submitNewPost() {
    const content = postContent.value.trim();
    if (!content) return;

    // Clear FIRST before anything else
    postContent.value = '';
    postContent.focus();

    const password = localStorage.getItem(STORAGE_KEY);
    if (!password) {
      showStatus('Please enter password first', 'error');
      return;
    }

    submitPost.disabled = true;
    showStatus('Posting...', 'loading');

    try {
      const response = await fetch('/.netlify/functions/add-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          content,
          category: selectedCategory,
          password,
        }),
      });

      const data = await response.json();

      if (response.ok) {
        showStatus('Posted!', 'success');
        // Inject post into timeline immediately
        if (data.post) {
          document.dispatchEvent(new CustomEvent('post-added', { detail: data.post }));
        }
        // Reset category to update
        categoryBtns.forEach(b => b.classList.remove('active'));
        document.getElementById('category-update')?.classList.add('active');
        selectedCategory = 'update';
      } else {
        // Show error but never kick back to password screen
        const errorMsg = data.error || `Error ${response.status}`;
        showStatus(errorMsg, 'error');
        console.error('Post failed:', response.status, data);
      }
    } catch (error) {
      showStatus('Network error. Check console.', 'error');
      console.error('Network error:', error);
    } finally {
      submitPost.disabled = false;
    }
  }

  function showStatus(message: string, type: 'success' | 'error' | 'loading') {
    statusMessage.textContent = message;
    statusMessage.className = `mt-4 text-sm status-${type}`;
    statusMessage.classList.remove('hidden');

    if (type === 'success') {
      setTimeout(() => {
        statusMessage.classList.add('hidden');
      }, 5000);
    }
  }

  submitPost.addEventListener('click', submitNewPost);

  // Cmd+Enter to submit
  postContent.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
      e.preventDefault();
      submitNewPost();
    }
  });
</script>
